<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ –î–∏—Ç—è—á–∏–π –ü–æ–≤—ñ—Ç—Ä—è–Ω–∏–π –û—Ä–∫–µ—Å—Ç—Ä</title>
    
    <!-- –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #311b92 100%);
            color: white;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }
        
        /* –í—ñ–¥–µ–æ - –º–æ–∂–Ω–∞ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –¥–ª—è –∫—Ä–∞—â–æ—ó –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ */
        #cameraView {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            opacity: 0.2;
        }
        
        /* –†–µ–∂–∏–º –±–µ–∑ –∫–∞–º–µ—Ä–∏ */
        .no-camera-mode .cameraView {
            display: none;
        }
        
        .title {
            position: fixed;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 32px;
            color: #FFEB3B;
            text-shadow: 0 0 15px #FF9800;
            z-index: 1000;
            animation: glow 2s infinite alternate;
            padding: 0 20px;
        }
        
        .instrument-selector {
            position: fixed;
            bottom: 100px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 1000;
            padding: 15px;
            flex-wrap: wrap;
        }
        
        .instrument-btn {
            background: rgba(255, 255, 255, 0.25);
            border: 3px solid white;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            min-width: 140px;
            font-weight: bold;
        }
        
        .instrument-btn:hover {
            transform: scale(1.05);
        }
        
        .instrument-btn.active {
            background: #FF4081;
            transform: scale(1.1);
            box-shadow: 0 0 25px #FF4081;
        }
        
        .finger-hint {
            position: fixed;
            bottom: 180px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 1000;
        }
        
        .finger-icon {
            font-size: 40px;
            margin: 0 8px;
            animation: pulse 1.5s infinite;
            display: inline-block;
        }
        
        .note-display {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 28px;
            color: #4CAF50;
            z-index: 999;
            min-height: 60px;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 1000;
            padding: 10px;
        }
        
        .control-btn {
            background: rgba(76, 175, 80, 0.7);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #311b92;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
            padding: 20px;
        }
        
        .loading-progress {
            width: 80%;
            max-width: 300px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        .loading-bar {
            width: 0%;
            height: 100%;
            background: #4CAF50;
            border-radius: 10px;
            transition: width 0.3s;
        }
        
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 2001;
            border: 3px solid white;
            display: none;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px #FF9800; }
            to { text-shadow: 0 0 25px #FF4081, 0 0 35px #FF4081; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .title { font-size: 24px; top: 10px; }
            .instrument-btn { 
                padding: 10px 15px; 
                font-size: 16px;
                min-width: 120px;
            }
            .finger-icon { font-size: 30px; margin: 0 5px; }
            .note-display { font-size: 22px; top: 70px; }
        }
    </style>
</head>
<body>
    <!-- –ï–ö–†–ê–ù –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø -->
    <div class="loading" id="loadingScreen">
        <div>
            <div style="font-size: 60px; animation: rainbow 3s infinite linear;">üéµüéπü•Åüéª</div>
            <h1 style="color: #FFEB3B; margin: 20px 0;">–î–∏—Ç—è—á–∏–π –ü–æ–≤—ñ—Ç—Ä—è–Ω–∏–π –û—Ä–∫–µ—Å—Ç—Ä</h1>
            <div>–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏...</div>
            <div class="loading-progress">
                <div class="loading-bar" id="loadingBar"></div>
            </div>
            <div id="loadingText" style="margin-top: 10px;">–ì–æ—Ç—É—î–º–æ –∫–∞–º–µ—Ä—É...</div>
        </div>
    </div>
    
    <!-- –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø –ü–†–û –ü–û–ú–ò–õ–ö–£ -->
    <div class="error-message" id="errorMessage">
        <div style="font-size: 50px;">‚ö†Ô∏è</div>
        <h3 id="errorTitle">–ü–æ–º–∏–ª–∫–∞</h3>
        <p id="errorText"></p>
        <button class="control-btn" onclick="location.reload()" style="margin-top: 15px;">–û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É</button>
    </div>

    <!-- –ì–û–õ–û–í–ù–Ü –ï–õ–ï–ú–ï–ù–¢–ò -->
    <div class="title">üéµ –î–ò–¢–Ø–ß–ò–ô –ü–û–í–Ü–¢–†–Ø–ù–ò–ô –û–†–ö–ï–°–¢–† üéµ</div>
    
    <div class="note-display" id="noteDisplay">
        –ü—ñ–¥–Ω—ñ–º–∞–π –ø–∞–ª—å—á–∏–∫–∏ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ—é! üëÜ
    </div>
    
    <div class="finger-hint" id="fingerHint">
        <div class="finger-icon">üëÜ</div>
        <div class="finger-icon">‚úåÔ∏è</div>
        <div class="finger-icon">ü§ò</div>
        <div class="finger-icon">üññ</div>
        <div class="finger-icon">ü§ü</div>
    </div>

    <!-- –í–ò–ë–Ü–† –Ü–ù–°–¢–†–£–ú–ï–ù–¢–Ü–í -->
    <div class="instrument-selector">
        <button class="instrument-btn active" onclick="switchInstrument('piano')">üéπ –§–æ—Ä—Ç–µ–ø—ñ–∞–Ω–æ</button>
        <button class="instrument-btn" onclick="switchInstrument('animals')">üê∂ –¢–≤–∞—Ä–∏–Ω–∏</button>
        <button class="instrument-btn" onclick="switchInstrument('drums')">ü•Å –ë–∞—Ä–∞–±–∞–Ω–∏</button>
        <button class="instrument-btn" onclick="switchInstrument('funny')">ü§° –°–º—ñ—à–Ω—ñ –∑–≤—É–∫–∏</button>
        <button class="instrument-btn" onclick="switchInstrument('bells')">üîî –î–∑–≤—ñ–Ω–æ—á–∫–∏</button>
    </div>

    <!-- –£–ü–†–ê–í–õ–Ü–ù–ù–Ø -->
    <div class="controls">
        <button class="control-btn" onclick="toggleCameraMode()">üì∏ –†–µ–∂–∏–º –±–µ–∑ –∫–∞–º–µ—Ä–∏</button>
        <button class="control-btn" onclick="toggleMute()">üîä –£–≤—ñ–º–∫./–í–∏–º–∫. –∑–≤—É–∫</button>
        <button class="control-btn" onclick="showHelp()">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
    </div>

    <!-- –í–Ü–î–ï–û –¢–ê 3D -->
    <video id="cameraView" autoplay playsinline muted></video>
    <canvas id="canvas3d"></canvas>

    <script>
        // ========== –ö–û–ù–°–¢–ê–ù–¢–ò –¢–ê –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ==========
        const CONFIG = {
            VOLUME: 0.5,
            NOTE_SCALE: ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4'],
            MAX_HANDS: 2,
            FIST_THRESHOLD: 0.05,
            DEBOUNCE_TIME: 500
        };

        // ========== –°–ò–°–¢–ï–ú–ù–Ü –ó–ú–Ü–ù–ù–Ü ==========
        let scene, camera, renderer;
        let hands, cameraStream;
        let currentInstrument = 'piano';
        let isMuted = false;
        let isCameraMode = true;
        let lastGestureTime = 0;
        
        // –ü—É–ª–∏ –æ–±'—î–∫—Ç—ñ–≤ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
        let activeFingers = new Map();
        let soundPools = {
            piano: null,
            animals: [],
            drums: [],
            funny: [],
            bells: []
        };
        let visualPool = [];
        
        // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
        const elements = {
            loading: document.getElementById('loadingScreen'),
            loadingBar: document.getElementById('loadingBar'),
            loadingText: document.getElementById('loadingText'),
            errorMessage: document.getElementById('errorMessage'),
            errorTitle: document.getElementById('errorTitle'),
            errorText: document.getElementById('errorText'),
            noteDisplay: document.getElementById('noteDisplay'),
            fingerHint: document.getElementById('fingerHint'),
            cameraView: document.getElementById('cameraView'),
            canvas3d: document.getElementById('canvas3d')
        };

        // ========== –£–¢–Ü–õ–Ü–¢–ò ==========
        function updateLoading(percent, text) {
            elements.loadingBar.style.width = percent + '%';
            elements.loadingText.textContent = text;
        }

        function showError(title, message) {
            elements.errorTitle.textContent = title;
            elements.errorText.textContent = message;
            elements.errorMessage.style.display = 'block';
            elements.loading.style.display = 'none';
        }

        // ========== –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ê–£–î–Ü–û ==========
        async function initAudio() {
            updateLoading(10, "–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∞—É–¥—ñ–æ...");
            
            // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª—ñ–∫—É –¥–ª—è –∑–∞–ø—É—Å–∫—É –∞—É–¥—ñ–æ
            const startAudio = async () => {
                try {
                    await Tone.start();
                    console.log("–ê—É–¥—ñ–æ —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞");
                    await loadAllSounds();
                } catch (error) {
                    showError("–ü–æ–º–∏–ª–∫–∞ –∞—É–¥—ñ–æ", "–ù–µ –≤–¥–∞–ª–æ—Å—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∑–≤—É–∫. –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.");
                }
            };
            
            // –°—Ç–∞—Ä—Ç –ø–æ –∫–ª—ñ–∫—É –∞–±–æ —Ç–∞–ø—É
            document.body.addEventListener('click', startAudio, { once: true });
            document.body.addEventListener('touchstart', startAudio, { once: true });
        }

        // ========== –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –í–°–Ü–• –ó–í–£–ö–Ü–í ==========
        async function loadAllSounds() {
            updateLoading(20, "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ñ–æ—Ä—Ç–µ–ø—ñ–∞–Ω–æ...");
            
            // –§–æ—Ä—Ç–µ–ø—ñ–∞–Ω–æ
            soundPools.piano = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: 'sine' },
                envelope: {
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 0.5
                }
            }).toDestination();
            
            updateLoading(30, "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç–≤–∞—Ä–∏–Ω–æ–∫...");
            
            // –ó–≤—É–∫–∏ —Ç–≤–∞—Ä–∏–Ω (–ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ)
            const animalUrls = [
                'https://assets.mixkit.co/sfx/preview/mixkit-cat-meow-109.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-dog-barking-109.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-cow-moo-110.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-pig-snort-110.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-rooster-crowing-246.mp3'
            ];
            
            for (let i = 0; i < animalUrls.length; i++) {
                const player = new Tone.Player(animalUrls[i]).toDestination();
                await player.load();
                soundPools.animals.push(player);
            }
            
            updateLoading(50, "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –±–∞—Ä–∞–±–∞–Ω–∏...");
            
            // –ë–∞—Ä–∞–±–∞–Ω–∏ (–ø—É–ª –≥—Ä–∞–≤—Ü—ñ–≤)
            const drumUrls = [
                'https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3',
                'https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3',
                'https://tonejs.github.io/audio/drum-samples/CR78/hh.mp3',
                'https://tonejs.github.io/audio/drum-samples/CR78/clap.mp3',
                'https://tonejs.github.io/audio/drum-samples/CR78/tom.mp3'
            ];
            
            for (let i = 0; i < drumUrls.length; i++) {
                const player = new Tone.Player(drumUrls[i]).toDestination();
                await player.load();
                soundPools.drums.push(player);
            }
            
            updateLoading(70, "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–º—ñ—à–Ω—ñ –∑–≤—É–∫–∏...");
            
            // –°–º—ñ—à–Ω—ñ –∑–≤—É–∫–∏
            const funnyUrls = [
                'https://assets.mixkit.co/sfx/preview/mixkit-cartoon-toy-whistle-247.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-cartoon-crazy-laugh-383.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-cartoon-jump-591.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-cartoon-bubble-pop-up-3003.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-cartoon-spring-boing-789.mp3'
            ];
            
            for (let i = 0; i < funnyUrls.length; i++) {
                const player = new Tone.Player(funnyUrls[i]).toDestination();
                await player.load();
                soundPools.funny.push(player);
            }
            
            updateLoading(90, "–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∑–≤—ñ–Ω–æ—á–∫–∏...");
            
            // –î–∑–≤—ñ–Ω–æ—á–∫–∏
            const bellUrls = [
                'https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-magic-sparkles-300.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-fairy-sparkle-852.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-wind-chimes-909.mp3',
                'https://assets.mixkit.co/sfx/preview/mixkit-crystal-bell-3111.mp3'
            ];
            
            for (let i = 0; i < bellUrls.length; i++) {
                const player = new Tone.Player(bellUrls[i]).toDestination();
                await player.load();
                soundPools.bells.push(player);
            }
            
            updateLoading(100, "–ì–æ—Ç–æ–≤–æ! –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –Ω–∞ –µ–∫—Ä–∞–Ω");
        }

        // ========== –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø THREE.JS ==========
        function initThreeJS() {
            // –°—Ü–µ–Ω–∞
            scene = new THREE.Scene();
            scene.background = null;
            
            // –ö–∞–º–µ—Ä–∞
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.z = 5;
            
            // –†–µ–Ω–¥–µ—Ä–µ—Ä
            renderer = new THREE.WebGLRenderer({ 
                canvas: elements.canvas3d, 
                alpha: true, 
                antialias: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            
            // –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);
            
            // –°–æ–∑–¥–∞—î–º–æ –ø—É–ª –≤—É–∑–∞–ª—ñ–∑–∞—Ç–æ—Ä—ñ–≤
            createVisualPool();
            
            // –ê–Ω—ñ–º–∞—Ü—ñ–π–Ω–∏–π —Ü–∏–∫–ª
            animate();
        }

        function createVisualPool() {
            // –°—Ç–≤–æ—Ä—é—î–º–æ –ø—É–ª –∑ 50 –æ–±'—î–∫—Ç—ñ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
            for (let i = 0; i < 50; i++) {
                const geometry = new THREE.SphereGeometry(0.1, 16, 16);
                const material = new THREE.MeshPhongMaterial({
                    color: 0xFF4081,
                    transparent: true,
                    opacity: 0
                });
                
                const sphere = new THREE.Mesh(geometry, material);
                sphere.visible = false;
                scene.add(sphere);
                visualPool.push(sphere);
            }
        }

        function getVisualFromPool() {
            // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–µ–≤–∏–¥–∏–º–∏–π –æ–±'—î–∫—Ç –∑ –ø—É–ª—É
            for (const visual of visualPool) {
                if (!visual.visible) {
                    return visual;
                }
            }
            
            // –Ø–∫—â–æ –≤—Å—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ, —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π
            const geometry = new THREE.SphereGeometry(0.1, 16, 16);
            const material = new THREE.MeshPhongMaterial({
                color: 0xFF4081,
                transparent: true,
                opacity: 0
            });
            
            const sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);
            visualPool.push(sphere);
            return sphere;
        }

        // ========== –¢–†–ï–ö–Ü–ù–ì –†–£–ö ==========
        async function initHandTracking() {
            try {
                updateLoading(40, "–ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —Ç—Ä–µ–∫—ñ–Ω–≥ —Ä—É–∫...");
                
                hands = new Hands({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });

                hands.setOptions({
                    maxNumHands: CONFIG.MAX_HANDS,
                    modelComplexity: 0,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                hands.onResults(onHandResults);
                
                await startCamera();
                
            } catch (error) {
                console.warn("–ü–æ–º–∏–ª–∫–∞ —Ç—Ä–µ–∫—ñ–Ω–≥—É —Ä—É–∫:", error);
                enableTouchMode();
            }
        }

        async function startCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("–ö–∞–º–µ—Ä–∞ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è");
                }
                
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "user",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                elements.cameraView.srcObject = cameraStream;
                
                // –û–±—Ä–æ–±–∫–∞ –∫–∞–¥—Ä—ñ–≤
                const processFrame = async () => {
                    if (elements.cameraView.readyState >= 2) {
                        try {
                            await hands.send({ image: elements.cameraView });
                        } catch (e) {
                            console.warn("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∫–∞–¥—Ä—É:", e);
                        }
                    }
                    requestAnimationFrame(processFrame);
                };
                
                elements.cameraView.onloadeddata = processFrame;
                
            } catch (error) {
                console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–∞–º–µ—Ä—É:", error);
                enableTouchMode();
            }
        }

        function enableTouchMode() {
            isCameraMode = false;
            document.body.classList.add('no-camera-mode');
            elements.noteDisplay.textContent = "–¢–æ—Ä–∫–∞–π—Å—è –µ–∫—Ä–∞–Ω—É –¥–ª—è –≥—Ä–∏! üëá";
            elements.fingerHint.style.display = 'none';
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ —Ç–æ—Ä–∫–∞–Ω–Ω—è
            document.addEventListener('pointerdown', handleTouch);
            document.addEventListener('touchstart', handleTouch);
            
            showError("–†–µ–∂–∏–º –±–µ–∑ –∫–∞–º–µ—Ä–∏", 
                "–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ì—Ä–∞—î–º–æ —Ç–æ—Ä–∫–∞–Ω–Ω—è–º –µ–∫—Ä–∞–Ω—É! üëá\n\n" +
                "‚Ä¢ –¢–æ—Ä–∫–∞–π—Å—è —Ä—ñ–∑–Ω–∏—Ö –º—ñ—Å—Ü—å –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –∑–≤—É–∫—ñ–≤\n" +
                "‚Ä¢ –¢—Ä–∏–º–∞–π –ø–∞–ª–µ—Ü—å –¥–ª—è —Ç—Ä–∏–≤–∞–ª–æ–≥–æ –∑–≤—É–∫—É\n" +
                "‚Ä¢ –ö–ª–∞—Ü–∞–π —à–≤–∏–¥–∫–æ –¥–ª—è —Ä–∏—Ç–º—É"
            );
        }

        // ========== –û–ë–†–û–ë–ö–ê –¢–û–†–ö–ê–ù–¨ ==========
        function handleTouch(event) {
            event.preventDefault();
            
            const x = event.clientX || event.touches[0].clientX;
            const y = event.clientY || event.touches[0].clientY;
            
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –∑–≤—É–∫—É –∑–∞ –ø–æ–∑–∏—Ü—ñ—î—é
            const sectionWidth = window.innerWidth / 5;
            const fingerIndex = Math.min(4, Math.floor(x / sectionWidth));
            
            playSound(fingerIndex);
            createTouchEffect(x, y);
        }

        // ========== –û–ë–†–û–ë–ö–ê –†–£–ö ==========
        function onHandResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                elements.fingerHint.style.opacity = '0.5';
                return;
            }
            
            elements.fingerHint.style.opacity = '1';
            
            const currentTime = Date.now();
            
            results.multiHandLandmarks.forEach((landmarks, handIndex) => {
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∂–µ—Å—Ç –∫—É–ª–∞–∫–∞
                if (isFistGesture(landmarks) && currentTime - lastGestureTime > CONFIG.DEBOUNCE_TIME) {
                    lastGestureTime = currentTime;
                    switchToNextInstrument();
                    return;
                }
                
                // –û–±—Ä–æ–±–ª—è—î–º–æ –ø–∞–ª—å—Ü—ñ
                processFingers(landmarks, handIndex);
            });
            
            updateDisplay();
        }

        function isFistGesture(landmarks) {
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ, —á–∏ –≤—Å—ñ –ø–∞–ª—å—Ü—ñ –∑–≥–æ—Ä–Ω—É—Ç—ñ
            const fingerPairs = [
                { tip: 4, base: 2 },  // –í–µ–ª–∏–∫–∏–π
                { tip: 8, base: 6 },  // –í–∫–∞–∑—ñ–≤–Ω–∏–π
                { tip: 12, base: 10 }, // –°–µ—Ä–µ–¥–Ω—ñ–π
                { tip: 16, base: 14 }, // –ë–µ–∑—ñ–º–µ–Ω–Ω–∏–π
                { tip: 20, base: 18 }  // –ú—ñ–∑–∏–Ω–µ—Ü—å
            ];
            
            let curledCount = 0;
            
            fingerPairs.forEach(pair => {
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫—ñ–Ω—á–∏–∫ –ø–∞–ª—å—Ü—è –±–ª–∏–∂—á–µ –¥–æ –∫–∞–º–µ—Ä–∏ (z-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –±—ñ–ª—å—à–∞)
                if (landmarks[pair.tip].z > landmarks[pair.base].z + CONFIG.FIST_THRESHOLD) {
                    curledCount++;
                }
            });
            
            // –ö—É–ª–∞–∫ - –∫–æ–ª–∏ 4 –∞–±–æ 5 –ø–∞–ª—å—Ü—ñ–≤ –∑–≥–æ—Ä–Ω—É—Ç—ñ
            return curledCount >= 4;
        }

        function processFingers(landmarks, handIndex) {
            const fingerTips = [
                { index: 4, name: 'thumb' },
                { index: 8, name: 'index' },
                { index: 12, name: 'middle' },
                { index: 16, name: 'ring' },
                { index: 20, name: 'pinky' }
            ];
            
            fingerTips.forEach((finger, i) => {
                const tip = landmarks[finger.index];
                const base = landmarks[finger.index - 2];
                
                // –ü–∞–ª–µ—Ü—å –ø—ñ–¥–Ω—è—Ç–∏–π, —è–∫—â–æ –∫—ñ–Ω—á–∏–∫ –≤–∏—â–µ –æ—Å–Ω–æ–≤–∏
                if (tip.y < base.y - 0.03) {
                    const key = `${handIndex}-${i}`;
                    
                    if (!activeFingers.has(key)) {
                        activeFingers.set(key, { index: i, position: tip });
                        playSound(i);
                        createFingerEffect(tip, handIndex);
                    }
                } else {
                    const key = `${handIndex}-${i}`;
                    if (activeFingers.has(key)) {
                        activeFingers.delete(key);
                    }
                }
            });
        }

        // ========== –í–Ü–î–¢–í–û–†–ï–ù–ù–Ø –ó–í–£–ö–Ü–í ==========
        function playSound(fingerIndex) {
            if (isMuted) return;
            
            const now = Tone.now();
            
            switch(currentInstrument) {
                case 'piano':
                    playPianoSound(fingerIndex, now);
                    break;
                case 'animals':
                    playAnimalSound(fingerIndex, now);
                    break;
                case 'drums':
                    playDrumSound(fingerIndex, now);
                    break;
                case 'funny':
                    playFunnySound(fingerIndex, now);
                    break;
                case 'bells':
                    playBellSound(fingerIndex, now);
                    break;
            }
        }

        function playPianoSound(index, time) {
            if (!soundPools.piano) return;
            
            const note = CONFIG.NOTE_SCALE[index % CONFIG.NOTE_SCALE.length];
            soundPools.piano.triggerAttackRelease(note, '8n', time);
        }

        function playAnimalSound(index, time) {
            if (soundPools.animals[index % soundPools.animals.length]) {
                const player = soundPools.animals[index % soundPools.animals.length];
                player.start(time);
            }
        }

        function playDrumSound(index, time) {
            if (soundPools.drums[index % soundPools.drums.length]) {
                const player = soundPools.drums[index % soundPools.drums.length];
                player.start(time);
            }
        }

        function playFunnySound(index, time) {
            if (soundPools.funny[index % soundPools.funny.length]) {
                const player = soundPools.funny[index % soundPools.funny.length];
                player.start(time);
            }
        }

        function playBellSound(index, time) {
            if (soundPools.bells[index % soundPools.bells.length]) {
                const player = soundPools.bells[index % soundPools.bells.length];
                player.start(time);
            }
        }

        // ========== –í–Ü–ó–£–ê–õ–¨–ù–Ü –ï–§–ï–ö–¢–ò ==========
        function createFingerEffect(position, handIndex) {
            const visual = getVisualFromPool();
            
            // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏
            const x = (position.x * 2 - 1) * 5;
            const y = -(position.y * 2 - 1) * 3;
            
            visual.position.set(x, y, -2);
            visual.material.color.setHSL(Math.random(), 0.8, 0.6);
            visual.scale.setScalar(0.1);
            visual.visible = true;
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è —á–µ—Ä–µ–∑ GSAP
            gsap.to(visual.scale, {
                x: 2,
                y: 2,
                z: 2,
                duration: 0.4,
                ease: "power2.out"
            });
            
            gsap.to(visual.material, {
                opacity: 0,
                duration: 0.4,
                delay: 0.1,
                onComplete: () => {
                    visual.visible = false;
                    visual.scale.setScalar(0.1);
                }
            });
        }

        function createTouchEffect(x, y) {
            const visual = getVisualFromPool();
            
            // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –µ–∫—Ä–∞–Ω–∞ –≤ Three.js
            const xPos = (x / window.innerWidth) * 10 - 5;
            const yPos = -(y / window.innerHeight) * 6 + 3;
            
            visual.position.set(xPos, yPos, -2);
            visual.material.color.setHSL(Math.random(), 0.9, 0.5);
            visual.scale.setScalar(0.1);
            visual.visible = true;
            
            gsap.to(visual.scale, {
                x: 1.5,
                y: 1.5,
                z: 1.5,
                duration: 0.3,
                ease: "back.out(1.7)"
            });
            
            gsap.to(visual.material, {
                opacity: 0,
                duration: 0.3,
                delay: 0.1,
                onComplete: () => {
                    visual.visible = false;
                    visual.scale.setScalar(0.1);
                }
            });
        }

        // ========== –Ü–ù–¢–ï–†–§–ï–ô–° ==========
        function updateDisplay() {
            if (activeFingers.size > 0) {
                const fingerNames = ['–í–µ–ª–∏–∫–∏–π', '–í–∫–∞–∑—ñ–≤–Ω–∏–π', '–°–µ—Ä–µ–¥–Ω—ñ–π', '–ë–µ–∑—ñ–º–µ–Ω–Ω–∏–π', '–ú—ñ–∑–∏–Ω–µ—Ü—å'];
                const fingers = Array.from(activeFingers.values()).map(f => fingerNames[f.index]);
                elements.noteDisplay.textContent = `–ì—Ä–∞—é—Ç—å: ${fingers.join(', ')}`;
                elements.noteDisplay.style.color = '#FFEB3B';
            } else if (isCameraMode) {
                elements.noteDisplay.textContent = "–ü—ñ–¥–Ω—ñ–º–∞–π –ø–∞–ª—å—á–∏–∫–∏ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ—é! üëÜ";
                elements.noteDisplay.style.color = '#4CAF50';
            }
        }

        function switchInstrument(instrument) {
            // –ó—É–ø–∏–Ω—è—î–º–æ –≤—Å—ñ –∞–∫—Ç–∏–≤–Ω—ñ –∑–≤—É–∫–∏
            activeFingers.clear();
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
            currentInstrument = instrument;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.instrument-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(getInstrumentName(instrument))) {
                    btn.classList.add('active');
                }
            });
            
            // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            showInstrumentMessage(instrument);
        }

        function getInstrumentName(instrument) {
            const names = {
                'piano': '–§–æ—Ä—Ç–µ–ø—ñ–∞–Ω–æ',
                'animals': '–¢–≤–∞—Ä–∏–Ω–∏',
                'drums': '–ë–∞—Ä–∞–±–∞–Ω–∏',
                'funny': '–°–º—ñ—à–Ω—ñ –∑–≤—É–∫–∏',
                'bells': '–î–∑–≤—ñ–Ω–æ—á–∫–∏'
            };
            return names[instrument] || instrument;
        }

        function showInstrumentMessage(instrument) {
            const messages = {
                'piano': 'üéπ –¢–µ–ø–µ—Ä —Ç–∏ –ø—ñ–∞–Ω—ñ—Å—Ç!',
                'animals': 'üê∂ –°–ª—É—Ö–∞–π–º–æ —Ç–≤–∞—Ä–∏–Ω–æ–∫!',
                'drums': 'ü•Å –ë–∞—Ä–∞–±–∞–Ω–Ω–∞ –¥—Ä–æ–±–∏–ª–∫–∞!',
                'funny': 'ü§° –°–º—ñ—à–Ω—ñ –∑–≤—É–∫–∏!',
                'bells': 'üîî –ß–∞—Ä—ñ–≤–Ω—ñ –¥–∑–≤—ñ–Ω–æ—á–∫–∏!'
            };
            
            const oldText = elements.noteDisplay.textContent;
            elements.noteDisplay.textContent = messages[instrument];
            elements.noteDisplay.style.color = '#FF4081';
            
            setTimeout(() => {
                if (elements.noteDisplay.textContent === messages[instrument]) {
                    elements.noteDisplay.textContent = oldText;
                    elements.noteDisplay.style.color = '#4CAF50';
                }
            }, 1500);
        }

        function switchToNextInstrument() {
            const instruments = ['piano', 'animals', 'drums', 'funny', 'bells'];
            const currentIndex = instruments.indexOf(currentInstrument);
            const nextIndex = (currentIndex + 1) % instruments.length;
            
            switchInstrument(instruments[nextIndex]);
        }

        // ========== –ö–ï–†–£–í–ê–ù–ù–Ø ==========
        function toggleCameraMode() {
            isCameraMode = !isCameraMode;
            
            if (isCameraMode && cameraStream) {
                document.body.classList.remove('no-camera-mode');
                elements.cameraView.style.display = 'block';
                elements.noteDisplay.textContent = "–ü—ñ–¥–Ω—ñ–º–∞–π –ø–∞–ª—å—á–∏–∫–∏ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ—é! üëÜ";
                elements.fingerHint.style.display = 'block';
            } else {
                document.body.classList.add('no-camera-mode');
                elements.cameraView.style.display = 'none';
                elements.noteDisplay.textContent = "–¢–æ—Ä–∫–∞–π—Å—è –µ–∫—Ä–∞–Ω—É –¥–ª—è –≥—Ä–∏! üëá";
                elements.fingerHint.style.display = 'none';
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            
            if (isMuted) {
                Tone.Destination.mute = true;
                elements.noteDisplay.textContent = "üîá –ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–æ";
            } else {
                Tone.Destination.mute = false;
                elements.noteDisplay.textContent = "üîä –ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ";
            }
            
            setTimeout(() => updateDisplay(), 1000);
        }

        function showHelp() {
            alert(
                "üéµ –î–ò–¢–Ø–ß–ò–ô –ü–û–í–Ü–¢–†–Ø–ù–ò–ô –û–†–ö–ï–°–¢–† üéµ\n\n" +
                "–Ø–ö –ì–†–ê–¢–ò:\n" +
                "‚Ä¢ –ü—ñ–¥–Ω—ñ–º–∞–π –ø–∞–ª—å—Ü—ñ –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ—é\n" +
                "‚Ä¢ –ö—É–ª–∞–∫ = –∑–º—ñ–Ω–∞ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞\n" +
                "‚Ä¢ –¢–æ—Ä–∫–∞–π—Å—è –µ–∫—Ä–∞–Ω—É –±–µ–∑ –∫–∞–º–µ—Ä–∏\n\n" +
                "–Ü–ù–°–¢–†–£–ú–ï–ù–¢–ò:\n" +
                "üéπ –§–æ—Ä—Ç–µ–ø—ñ–∞–Ω–æ - –º—É–∑–∏—á–Ω—ñ –Ω–æ—Ç–∏\n" +
                "üê∂ –¢–≤–∞—Ä–∏–Ω–∏ - –∑–≤—É–∫–∏ –∑–≤—ñ—Ä–∫—ñ–≤\n" +
                "ü•Å –ë–∞—Ä–∞–±–∞–Ω–∏ - —É–¥–∞—Ä–Ω—ñ –∑–≤—É–∫–∏\n" +
                "ü§° –°–º—ñ—à–Ω—ñ - –≥—É–º–æ—Ä–Ω—ñ –∑–≤—É–∫–∏\n" +
                "üîî –î–∑–≤—ñ–Ω–æ—á–∫–∏ - –º–∞–≥—ñ—á–Ω—ñ –∑–≤—É–∫–∏"
            );
        }

        // ========== –ê–ù–Ü–ú–ê–¶–Ü–Ø ==========
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        // ========== –ó–ê–ü–£–°–ö –ü–†–û–ì–†–ê–ú–ò ==========
        async function init() {
            try {
                await Promise.all([
                    initAudio(),
                    initThreeJS(),
                    initHandTracking()
                ]);
                
                // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                setTimeout(() => {
                    elements.loading.style.opacity = '0';
                    setTimeout(() => {
                        elements.loading.style.display = 'none';
                    }, 500);
                }, 1000);
                
            } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:", error);
                showError("–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É", 
                    "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º—É. –°–ø—Ä–æ–±—É–π—Ç–µ:\n" +
                    "1. –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É\n" +
                    "2. –î–æ–∑–≤–æ–ª–∏—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏\n" +
                    "3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑'—î–¥–Ω–∞–Ω–Ω—è"
                );
            }
        }

        // ========== –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–î–Ü–ô ==========
        window.addEventListener('load', init);
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // –ï–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü—ñ–π
        window.switchInstrument = switchInstrument;
        window.toggleCameraMode = toggleCameraMode;
        window.toggleMute = toggleMute;
        window.showHelp = showHelp;
    </script>
</body>
</html>
