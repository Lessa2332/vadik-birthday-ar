
<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <title>З Днем Народження, Вадік!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body { margin: 0; overflow: hidden; }
    #canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    #startButton { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; font-size: 24px; z-index: 10; }
    #greeting { position: absolute; top: 20%; width: 100%; text-align: center; color: white; font-size: 24px; font-family: Arial; text-shadow: 2px 2px 4px black; display: none; z-index: 10; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
</head>
<body>
  <button id="startButton">Запустити AR-привітання</button>
  <div id="greeting">З днем народження, Вадік!<br>За твоє здоров'я, успіхи та круті пригоди!</div>
  <script>
    const videoElement = document.createElement('video');
    videoElement.style.display = 'none';
    document.body.appendChild(videoElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);
    renderer.domElement.id = 'canvas';

    // Келих з примітивів
    const glassGroup = new THREE.Group();
    // Ніжка (конус)
    const stem = new THREE.Mesh(new THREE.ConeGeometry(0.03, 0.1, 32), new THREE.MeshBasicMaterial({color: 0xffd700}));
    stem.position.y = 0.05;
    glassGroup.add(stem);
    // Основа (циліндр)
    const bowl = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.15, 32), new THREE.MeshBasicMaterial({color: 0xffffff, transparent: true, opacity: 0.3}));
    bowl.position.y = 0.15;
    glassGroup.add(bowl);
    // Рідина (сфера)
    const liquid = new THREE.Mesh(new THREE.SphereGeometry(0.05, 32, 32), new THREE.MeshBasicMaterial({color: 0xffcc00, transparent: true, opacity: 0.6}));
    liquid.position.y = 0.18;
    glassGroup.add(liquid);

    scene.add(glassGroup);
    glassGroup.visible = false;

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.8, minTrackingConfidence: 0.8 });
    hands.onResults(onResults);

    const cameraUtils = new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 1280, height: 720 });
    
    function onResults(results) {
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        // Центр долоні ≈ середнє між landmark 0 (зап'ястя) та 9 (середній палець основа)
        const palmCenter = new THREE.Vector3(
          (landmarks[0].x + landmarks[9].x) / 2,
          1 - (landmarks[0].y + landmarks[9].y) / 2,  // інвертуємо Y
          - (landmarks[0].z + landmarks[9].z) / 2   // Z для глибини
        );
        // Конвертуємо з нормалізованих координат в world space (приблизно)
        palmCenter.x = (palmCenter.x - 0.5) * 1.5;
        palmCenter.y = (palmCenter.y - 0.5) * 1.5;
        palmCenter.z = palmCenter.z * 2 - 0.5;

        glassGroup.position.copy(palmCenter);
        glassGroup.visible = true;

        // Pinch detection: відстань між кінчиком великого (4) та вказівного (8)
        const thumbTip = landmarks[4];
        const indexTip = landmarks[8];
        const distance = Math.sqrt(
          Math.pow(thumbTip.x - indexTip.x, 2) +
          Math.pow(thumbTip.y - indexTip.y, 2) +
          Math.pow(thumbTip.z - indexTip.z, 2)
        );
        document.getElementById('greeting').style.display = distance < 0.05 ? 'block' : 'none';
      } else {
        glassGroup.visible = false;
        document.getElementById('greeting').style.display = 'none';
      }
    }

    document.getElementById('startButton').addEventListener('click', () => {
      document.getElementById('startButton').style.display = 'none';
      cameraUtils.start();
    });

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
